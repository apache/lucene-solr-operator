language: go
services:
  - docker

go:
  - "1.13"
  - master

script:
  - docker --version
  - make clean
  - ./hack/install_dependencies.sh

  # build locally and run locally
  - make manifests
  - make build

  - make test
  - make manifests-check

jobs:
  include:
    - stage: "Docker"
      name: "Build (& Release if tagged)"
      script:
        - make docker-vendor-build
      deploy:
        - provider: script
          script: bash docker_deploy.sh
          skip_cleanup: true
          on:
            tags: true
            condition: -n "$DOCKER_PASSWORD"
